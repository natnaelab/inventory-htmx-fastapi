{% extends "base.html" %}

{% block title %}Audit Logs - Admin - Inventory Management System{% endblock %}

{% block header %}
<div class="row align-items-center mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <li class="breadcrumb-item active">Admin - Audit Logs</li>
            </ol>
        </nav>
        <h1 class="mb-0">
            <i class="fas fa-shield-alt text-primary me-3"></i>
            Audit Logs
        </h1>
        <p class="text-muted mb-0">System activity and request logging</p>
    </div>
    <div class="col-auto">
    </div>
</div>
{% endblock %}

{% block content %}
{% if error_message %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error_message }}
</div>
{% endif %}

<!-- Statistics Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ stats.total_requests }}</h3>
                <p class="text-muted mb-0">Total Requests<br><small>(Last 30 days)</small></p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h3 class="text-danger">{{ stats.error_count }}</h3>
                <p class="text-muted mb-0">Error Requests<br><small>({{ "%.1f"|format(stats.error_rate) }}% error rate)</small></p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h3 class="text-info">{{ stats.avg_response_time_ms }}ms</h3>
                <p class="text-muted mb-0">Avg Response Time</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h3 class="text-success">{{ stats.status_codes.get('200', 0) }}</h3>
                <p class="text-muted mb-0">Successful Requests<br><small>(HTTP 200)</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Status Code Distribution -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Status Code Distribution
                </h6>
            </div>
            <div class="card-body">
                {% for status_code, count in stats.status_codes.items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-{{ 'success' if status_code.startswith('2') else 'danger' if status_code.startswith('4') or status_code.startswith('5') else 'warning' }}">
                        {{ status_code }}
                    </span>
                    <span>{{ count }} requests</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Top Endpoints
                </h6>
            </div>
            <div class="card-body">
                {% for endpoint in stats.top_endpoints %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <code class="small">{{ endpoint.path }}</code>
                    <span class="badge bg-primary">{{ endpoint.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Errors -->
<div class="card">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
            Recent Errors (Last 20)
        </h6>
    </div>
    <div class="card-body">
        {% if recent_errors %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Method</th>
                        <th>Path</th>
                        <th>Status</th>
                        <th>IP</th>
                        <th>Response Time</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody>
                    {% for error in recent_errors %}
                    <tr>
                        <td class="small">{{ error.timestamp[:19] if error.timestamp else 'N/A' }}</td>
                        <td><span class="badge bg-secondary">{{ error.method or 'N/A' }}</span></td>
                        <td><code class="small">{{ error.path or 'N/A' }}</code></td>
                        <td><span class="badge bg-danger">{{ error.status_code or 'N/A' }}</span></td>
                        <td class="small">{{ error.remote_addr or 'N/A' }}</td>
                        <td class="small">{{ error.response_time_ms or 0 }}ms</td>
                        <td class="small text-muted">{{ (error.error_message[:50] if error.error_message else 'N/A') }}{% if error.error_message and error.error_message|length > 50 %}...{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-check-circle fa-3x mb-3"></i>
            <p>No recent errors found</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
