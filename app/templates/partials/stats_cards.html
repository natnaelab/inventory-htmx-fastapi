{% set active_status = request.query_params.get('status') %}
{% set status_counts = status_counts or {} %}
{% set base_params = request.query_params|remove('status')|remove('page') %}
{% set base_query = '?' ~ base_params if base_params else '' %}
{% set extra_query = '&' ~ base_params if base_params else '' %}
{% if active_status %}
    {% set active_label = active_status|replace('_', ' ')|title %}
{% else %}
    {% set active_label = 'All Devices' %}
{% endif %}
{% set shortcuts = [
    {
        'status': none,
        'label': 'Total Devices',
        'icon': 'fas fa-laptop',
        'count': total_count or 0,
        'accent': 'primary'
    },
    {
        'status': 'IN_STOCK',
        'label': 'In Stock',
        'icon': 'fas fa-warehouse',
        'count': status_counts.get('IN_STOCK', 0),
        'accent': 'success'
    },
    {
        'status': 'RESERVED',
        'label': 'Reserved',
        'icon': 'fas fa-clock',
        'count': status_counts.get('RESERVED', 0),
        'accent': 'warning'
    },
    {
        'status': 'IMAGING',
        'label': 'Imaging',
        'icon': 'fas fa-cog',
        'count': status_counts.get('IMAGING', 0),
        'accent': 'info'
    },
    {
        'status': 'SHIPPED',
        'label': 'Shipped',
        'icon': 'fas fa-shipping-fast',
        'count': status_counts.get('SHIPPED', 0),
        'accent': 'purple'
    },
    {
        'status': 'COMPLETED',
        'label': 'Completed',
        'icon': 'fas fa-check-circle',
        'count': status_counts.get('COMPLETED', 0),
        'accent': 'secondary'
    }
] %}

<div class="card stat-shortcuts-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="text-uppercase small fw-semibold text-muted">Hardware Statuses</span>
        <span class="badge bg-light text-secondary border">
            <i class="fas fa-filter me-1"></i>
            {{ active_label }}
        </span>
    </div>
    <div class="card-body">
        <div class="stat-shortcuts-list">
            {% for shortcut in shortcuts %}
                {% set is_all = shortcut.status is none %}
                {% set is_active = (is_all and not active_status) or (shortcut.status == active_status) %}
                {% if shortcut.status %}
                    {% set target_url = '/hardware?status=' ~ shortcut.status ~ (extra_query if extra_query else '') %}
                {% else %}
                    {% set target_url = '/hardware' ~ (base_query if base_query else '') %}
                {% endif %}
                <button type="button"
                        hx-get="{{ target_url }}"
                        hx-target="#hardware-table-container"
                        hx-push-url="true"
                        class="stat-shortcut {{ 'is-active' if is_active else '' }}"
                        data-dashboard-status="{{ shortcut.status or 'ALL' }}"
                        data-accent="{{ shortcut.accent }}"
                        aria-pressed="{{ 'true' if is_active else 'false' }}">
                    <div class="stat-shortcut-icon">
                        <i class="{{ shortcut.icon }}"></i>
                    </div>
                    <div class="stat-shortcut-details">
                        <span class="stat-shortcut-count">{{ shortcut.count }}</span>
                        <span class="stat-shortcut-label">{{ shortcut.label }}</span>
                    </div>
                    <i class="fas fa-chevron-right stat-shortcut-chevron" aria-hidden="true"></i>
                </button>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Stock Summary -->
{% if stock_summary %}
<div class="card stock-summary-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-semibold small text-uppercase">Models</h6>
        {% if stock_summary.alerts %}
        <span class="badge bg-danger-soft text-danger rounded-pill">
            <i class="fas fa-exclamation-triangle me-1"></i>
            {{ stock_summary.alert_count }} Alert{{ 's' if stock_summary.alert_count > 1 else '' }}
        </span>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <ul class="list-group list-group-flush stock-summary-list">
            {% for model, count in stock_summary.stock_counts.items() %}
            {% set model_name = stock_summary.model_names.get(model, model) %}
            {% set threshold = stock_summary.thresholds.get(model, 0) %}
            {% set is_low = count < threshold %}
            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'low-stock' if is_low else '' }}">
                <span>{{ model_name }}</span>
                <span class="fw-bold {{ 'text-danger' if is_low else '' }}">{{ count }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}
